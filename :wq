# GUI app
import tkinter as tk
from tkinter import ttk
from defaults import DefaultsUI as dui
from defaults import DefaultsFileManagent as dfm
from PIL import Image, ImageTk
from model import QRCode


class QRCodeGeneratorGUI(tk.Tk):

    qr_code: QRCode
    tk_image: ImageTk.PhotoImage

    label_image: tk.Label

    url_var: tk.StringVar
    title_var: tk.StringVar 
    output_dir_var: tk.StringVar 
    print_title_var: tk.BooleanVar 
    file_prefix_var: tk.StringVar 

    def __init__(self, qr_code: QRCode) -> None:
        super().__init__()
        self._build_layout()
        self._set_initial_values(qr_code)
        self._create_widgets()
        self._set_variable_bindings()

    def _create_widgets(self):

        form_frame = ttk.Frame()
        form_frame.grid(row=0, column=0, padx=20, pady=20, sticky="nsew")
        self._create_url_widget(form_frame)
        self._create_title_widget(form_frame)
        self._create_print_title_widget(form_frame)
        self._create_file_prefix_widget(form_frame)
        self._create_output_dir_widget(form_frame)
        self._create_save_widget(form_frame)

        image_frame = ttk.Frame()
        image_frame.grid(row=0, column=1, padx=20, pady=20, sticky="nsew")
        self._create_image_widget(image_frame)

    def _set_initial_values(self, qr_code: QRCode):
        self.qr_code = qr_code
        self.url_var = tk.StringVar(value=self.qr_code.url)
        self.title_var = tk.StringVar(value=self.qr_code.title)
        self.output_dir_var = tk.StringVar(value=self.qr_code.output_dir)
        self.print_title_var = tk.BooleanVar(value=self.qr_code.print_title)
        self.file_prefix_var = tk.StringVar(value=self.qr_code.file_prefix)

    def _set_variable_bindings(self):
        self.url_var.trace_add("write", self._on_url_change)
        self.title_var.trace_add("write", self._on_title_change)
        self.output_dir_var.trace_add("write", self._on_output_dir_change)
        self.print_title_var.trace_add("write", self._on_print_title_change)
        self.file_prefix_var.trace_add("write", self._on_file_prefix_change)

    def _on_file_prefix_change(self, *_):
        self.qr_code.file_prefix = self.file_prefix_var.get()

    def _on_print_title_change(self, *_):
        self.qr_code.print_title = self.print_title_var.get()

    def _on_output_dir_change(self, *_):
        self.qr_code.output_dir = self.output_dir_var.get()

    def _on_url_change(self, *_):
        self.qr_code.url = self.url_var.get()
        self._update_image_widget()

    def _on_title_change(self, *_):
        self.qr_code.title = self.title_var.get()

    def _build_layout(self):

        self.title = "QR Code Generator"

        self.columnconfigure(0, weight=1)
        self.columnconfigure(1, weight=1)


    def _create_title_widget(self, frame:ttk.Frame):
        # Title Label
        label_title: ttk.Label = ttk.Label(
            master=frame, text="QR code title (optional):"
        )
        label_title.pack(padx=dui.PADX, pady=dui.PADY, anchor="w")

        # Title entry box
        title_entry: ttk.Entry = ttk.Entry(
            master=frame, textvariable=self.title_var, width=dui.WIDTH
        )
        title_entry.pack(padx=dui.PADX, pady=dui.PADY, anchor="w")

    def _create_url_widget(self, frame: ttk.Frame):
        # URL label
        label_url: ttk.Label = ttk.Label(master=frame, text="URL:")
        label_url.pack(padx=dui.PADX, pady=dui.PADY, anchor="w")

        # URL Entry
        url_entry: ttk.Entry = ttk.Entry(
            master=frame, textvariable=self.url_var, width=dui.WIDTH
        )
        url_entry.pack(padx=dui.PADX, pady=dui.PADY, anchor="w")

    def _create_output_dir_widget(self, frame:ttk.Frame):
        # Output directory label
        label_output_dir: ttk.Label = ttk.Label(
            master=frame, text="Output directory:"
        )
        label_output_dir.pack(padx=dui.PADX, pady=dui.PADY, anchor="w")

        # Output directory Entry
        output_dir_entry: ttk.Entry = ttk.Entry(
            master=frame,
            textvariable=self.output_dir_var,
            width=dui.WIDTH,
        )
        output_dir_entry.pack(padx=dui.PADX, pady=dui.PADY, anchor="w")

    def _create_print_title_widget(self, frame:ttk.Frame):
        # Print title checkbox
        print_title_check: ttk.Checkbutton = ttk.Checkbutton(
            master=frame, text="Print title", variable=self.print_title_var
        )
        print_title_check.pack(padx=dui.PADX, pady=dui.PADY, anchor="w")

    def _create_file_prefix_widget(self, frame:ttk.Frame):
        # File prefix label
        label_file_prefix: ttk.Label = ttk.Label(
            master=frame, text="File prefix:"
        )
        label_file_prefix.pack(padx=dui.PADX, pady=dui.PADY, anchor="w")

        # File prefix entry
        file_prefix_entry: ttk.Entry = ttk.Entry(
            master=frame,
            textvariable=self.file_prefix_var,
            width=dui.WIDTH,
        )
        file_prefix_entry.pack(padx=dui.PADX, pady=dui.PADY, anchor="w")

    def _create_save_widget(self, frame:ttk.Frame):
        save_button: ttk.Button = ttk.Button(
            master=frame, text="Save Image", command=self._save_widget_on_click
        )
        save_button.pack(padx=dui.PADX, pady=dui.PADY, anchor="w")

    def _save_widget_on_click(self):
        print("clicked boby")

    def _create_image_widget(self, frame:ttk.Frame):
        self.tk_image = ImageTk.PhotoImage(self.qr_code.image)

        self.label_image = tk.Label(master=frame, image=self.tk_image)
        self.label_image.pack(padx=dui.PADX, pady=dui.PADY)

    def _update_image_widget(self):

        self.tk_image = ImageTk.PhotoImage(self.qr_code.image)
        self.label_image.configure(image=self.tk_image)
